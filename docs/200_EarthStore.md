# MuFo Document : EarthStore仕様

## 概要

EarthStoreはearth画面(マップ画面)に対応するデータの管理機能を提供します。マップの表示範囲の把握と、その中に存在するMuFoの一覧を管理します。

マップに表示される内容やユーザの現在位置等、マップそのものに関連するデータはサーバ側には送信/保存されません。また、マップの表示処理も基本的に画面表示側で行うことを想定しています。(機能に不足があればissueで上げてください)

## プロパティ

ストアのプロパティは全て参照専用です。
参照型(オブジェクト)の中身を変更してもデータは反映されません。

### {Object} center 中心座標

表示範囲の中心座標です。`lat`で緯度、`lng`で経度が取得できます。表示範囲が未設定の場合、どちらも0になります。(null等の緯度経度として無効な値になることはありません)

**例**

```javascript
const center = App.stores.earthStore.center;
console.log(`現在の一覧は緯度${center.lat}、経度${center.lng}です`);
```

### {number} radius 表示半径

表示範囲として指定されたエリアの半径です。
詳細は`EARTH_MOVE`アクションを参照。

### {Array[MufoModel]} 表示範囲のMuFo

現在の表示範囲に存在するMuFoの配列

### {string} focusedMufoid 

直近に`MUFO_JUMP`アクションで参照したMuFoのID。ない場合はnull

## アクション

### EARTH_MOVE 表示範囲変更

表示範囲を変更します。範囲変更によってMuFoに増減がある場合、`MUFOS_CHANGED`イベントが発行されます。

画面からは、任意の位置にジャンプしたい場合の他、**ユーザがマップを操作した場合にも適時**(タップイベントの終了時等に)このアクションを呼び出してください。

**引数**

|  名前  |  型  |  必須?  |  説明  |
| --- | --- | --- | --- |
|  center  |  Object{lng,lat}  |  Y  |  新しい中心座標。無効な座標を渡すとエラーとなり、表示範囲は変更されません  |
|  radius  |  number  |  Y  |  表示範囲の半径。単位はkmです。この半径内のMuFoが通知されます。画面のマップの表示スケールから計算して適切な値を渡して下さい  |

### EARTH_JUMP 指定のMuFoの位置に移動

MuFoのIDを指定して表示範囲を変更します。
このアクションは、ターゲットのMuFoの位置を取得して、その位置を使って`EARTH_MOVE`を呼び出すのとほぼ同等です(`focusedMufoid`で最後に飛んだMuFoのIDが取れるところだけが異なります)。

**引数**

|  名前  |  型  |  必須?  |  説明  |
| --- | --- | --- | --- |
|  mufoid  |  string  |  Y  |  ターゲットとなるMuFoのID  |
|  radius  |  number  |  Y  |  表示範囲の半径  |

## イベント

### EARTH_MOVED 表示範囲が変更された

表示範囲が変更された際に通知されるイベントです。
このイベントは画面でユーザがマップを操作した場合(`EARTH_MOVE`アクションの結果として)と他のアクションや状態変化の結果として(例えば攫われて別な位置にワープさせられた、等)の両方で発行されます。
このイベントを受け取った画面側では、通知された表示範囲の内容を元に、マップの変更が必要かどうかを判断する必要があります。

**コールバックの引数**

|  名前  |  型  |  説明  |
| --- | --- | --- |
|  center  |  Object{lat,lng}  |  現在の表示範囲の中心座標  |
|  radius  |  number  |  現在の表示範囲の半径  |

### EARTH_MUFOS_CHANGED 表示範囲のMuFoが増減した

現在の表示範囲に含まれるMuFoが増減した場合に**都度**呼び出されます。
MuFoが2ついるエリアから3ついるエリアに移動した場合、合計5回このイベントが発行されます。その後で表示範囲内に新たなMuFoが作られた場合、さらに1回このイベントが発行されます。

**コールバックの引数**

|  名前  |  型  |  説明  |
| --- | --- | --- |
|  mufos  |  Array[MufoModel]  |  現在の表示範囲のmufo  |
|  addedMufos  |  Array[MufoModel]  |  新たに追加されたMuFo。ない場合、空の配列  |
|  removedMufos  |  Array[MufoModel]  |  削除されたMuFo。ない場合、空の配列  |

追加・削除されたMuFoは配列として渡されますが、基本的には前述の通り追加・削除の都度呼び出されるため、配列内の要素の最大値は多くの場合1です。
（但し、検索がリセットされた場合等、一度に複数の値の追加削除が発生することもあり得ます）
